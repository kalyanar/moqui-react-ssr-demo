<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.0.xsd"
    default-menu-index="15" default-menu-title="React SSR Demo" require-authentication="anonymous-view" allow-extra-path="true"
    track-artifact-hit="false" standalone="true">
    <always-actions>
        <set field="basePath" value="/apps/react-ssr-demo"/>
    </always-actions>

    <pre-actions>
        <script><![CDATA[
        import com.moqui.ssr.React

        def reactAppCache = ec.cache.getCache('react.ssr.apps.ReactSSRDemo')

        ec.context.put('jsBrowserFileMap', reactAppCache.get('jsBrowserFileMap'))
        ec.context.put('cssFileMap', reactAppCache.get('cssFileMap'))

        // ec.logger.info("== ec.web.request.getCookies(): ${ec.web.request.getHeader("Cookie")}")
        // System.out.println(ec.web.request.getCookies())

        React react = ec.getTool("ReactSSR", React.class, "ReactSSRDemo")
        try {
            Map<String, Object> renderResult = react.render(ec.web.request)

            ec.context.put("content", renderResult.get("html") ?: "")

            Object storeState = renderResult.get("state")
            ec.context.put("storeState", storeState
                                         ? new groovy.json.JsonBuilder(renderResult.get("state")).toString()
                                         : "{}");
        } catch (org.moqui.context.AuthenticationRequiredException e) {
            ((org.moqui.impl.context.WebFacadeImpl) ec.web).saveScreenLastInfo(ec.web.request.getRequestURI(), ec.web.getRequestParameters())
            sri.sendRedirectAndStopRender('/Login')
        }
        ]]></script>
    </pre-actions>
    <widgets>
        <render-mode>
            <text type="html" template="true" location="component://moqui-react-ssr-demo/screen/ReactSSRRoot/includes/index.html.ftl"/>
        </render-mode>
    </widgets>
</screen>
